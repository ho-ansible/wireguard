[NetDev]
Name={{ wg_name }}
Kind=wireguard

[WireGuard]
ListenPort={{ wg_port }}
PrivateKey={{ wg_privkey }}
{% for key, value in wg_server_opts | d() %}
{{ key }}={{ value }}
{% endfor %}

{% for peer in q('inventory_hostnames', wg_peers) 
  if peer != inventory_hostname and hostvars[peer].wg_pubkey is defined %}
# {{ peer }}
[WireGuardPeer]
PublicKey={{ hostvars[peer].wg_pubkey }}
AllowedIPs={{ hostvars[peer].wg_ip | ipaddr('address') }}/32
{% for addr in hostvars[peer].wg_routes | d() %}
AllowedIPs={{ addr }}
{% endfor %}
{% if hostvars[peer].wg_address is defined %}
Endpoint={{ hostvars[peer].wg_address }}:{{ hostvars[peer].wg_port }}
{% endif %}
{% for key, value in hostvars[peer].wg_client_opts | d() %}
{{ key }}={{ value }}
{% endfor %}

{% endfor %}
