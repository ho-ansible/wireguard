[Match]
Name={{ wg_name }}

[Network]
Address={{ wg_ip }}
{{ wg_network_opts | d() }}

{% for peer in q('inventory_hostnames', wg_peers)
  if peer != inventory_hostname and hostvars[peer].wg_pubkey is defined %}
# {{ peer }}
{%   for addr in hostvars[peer].wg_routes | d() %}
[Route]
Destination={{ addr }}
{%   endfor %}

[RoutingPolicyRule]
IPProtocol=udp
DestinationPort={{ wg_port }}
{% if hostvars[peer].wg_address is defined and hostvars[peer].wg_address | length %}
From={{ hostvars[peer].wg_address }}
{% endif %}

{% endfor %}
