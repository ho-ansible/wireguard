[Match]
Name={{ wg_name }}

[Network]
Address={{ wg_ip }}
{{ wg_network_opts | d() }}

{% for peer in q('inventory_hostnames', wg_peers)
  if peer != inventory_hostname and hostvars[peer].wg_pubkey is defined %}
{%   set hv = hostvars[peer] %}
# {{ peer }}
{%   for subnet in hv.wg_routes | d() %}
[Route]
Destination={{ subnet }}
{%   endfor %}
[RoutingPolicyRule]
IPProtocol=udp
DestinationPort={{ wg_port | d(wg_default_port, true) }}
{% if (hv.wg_ext_ip | d()) and
      ( (hv.wg_ext_ip | ipaddr('address')) or
        (hv.ansible_default_ipv4 is defined) ) %}
{%   set peer_ip = hv.wg_ext_ip | ipaddr('address') | d(hv.ansible_default_ipv4.address, true) %}
From={{ peer_ip }}
{% endif %}

{% endfor %}
